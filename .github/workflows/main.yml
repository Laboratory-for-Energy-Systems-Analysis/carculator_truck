name: configuration for python env
on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10


    steps:
      - uses: actions/checkout@v2
      - name: Install python version
        uses: gabrielfalcao/pyenv-action@v7
        with:
          default: 3.8.6
          command: pip install -U pip  # upgrade pip after installing python

      - name: create environment
        run: pyenv local 3.8.6 && python -mvenv .venv386

      - name: Install dependencies
        run: pip install -r requirements.txt --upgrade pip

      - uses: actions/checkout@v2
      - name: Pytest
        uses: cclauss/GitHub-Action-for-pytest@0.5.0
        with:
          args: pytest "/home/runner/work/carculator_truck"

  lint:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout source code
      uses: actions/checkout@v2

    - name: Super-Linter
      uses: github/super-linter@v4
      env:
        DEFAULT_BRANCH: master
        IGNORE_GITIGNORED_FILES: true
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN}}

  black:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Black formatting
      uses: lgeiger/black-action@v1.0.1
      with:
        args: "./"

    - name: Run isort
      uses: jamescurtin/isort-action@master
      with:
        configuration: --profile black


    - name: Check for modified files
      id: git-check
      run: echo ::set-output name=modified::$(if git diff-index --quiet HEAD --; then echo "false"; else echo "true"; fi)

    - name: Push changes
      if: steps.git-check.outputs.modified == 'true'
      run: |
        git config --global user.email "r_s@me.com"
        git config --global user.name "romainsacchi"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$GITHUB_REPOSITORY
        git checkout $GITHUB_HEAD_REF
        git commit -am "Black reformating"
        git push



